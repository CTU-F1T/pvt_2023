# F1/10 @ CTU (ROS 2 port)

An attempt to port **f1tenth** codebase (`git@rtime.felk.cvut.cz:f1tenth`)
from **ROS 1** Kinetic Kame üê¢ to **ROS 2** Foxy Fitzroy ü¶ä.

üöß **NOTE:** The docs will be improved.


## Development

Currently, the project uses **ROS 2** [Foxy Fitzroy](https://docs.ros.org/en/foxy/index.html) ü¶ä.

_Note:_ We are aware that Foxy is no longer the most up-to-date release. But it is a LTS version.
However, we might upgrade to the [Galactic Geochelone](https://docs.ros.org/en/galactic/index.html) üåå
(it was released on May 23rd, 2021).


### Installation

Follow the ROS 2 Foxy [Installation guide](https://docs.ros.org/en/foxy/Installation.html) that is appropriate to your platform.
We tested:
* Ubuntu 20.04
* macOS 10.14.6

In order to install the stage Simulator and its binding for ROS 2, refer to
the [ros2-build](https://github.com/pokusew/ros2-build) repository.


### Building

After you built the [ros2-build](https://github.com/pokusew/ros2-build) workspace,
open a clean terminal. ROS 2 Foxy does not need to be sourced (but it may).
Then source `../path/to/ros2-build/install/setup.bash`.

Build the f1tenth workspace using:
```bash
cd ws
colcon build --symlink-install --cmake-args -DCMAKE_EXPORT_COMPILE_COMMANDS=1
```


### Running

Open a clean terminal. ROS 2 Foxy does not need to be sourced (but it may).
Source `ws/install/setup.bash` (after you built the project).

Then you can run the Follow the Gap demo in the Stage simulator using the following launch command:
```bash
ros2 launch launchers stage_sample_ftg.launch.py
```


### Usage with IDEs

Please refer to the [ros-setup](https://github.com/pokusew/ros-setup) that contains useful information
about:
* Using VSCode with ROS (including Remote mode over SSH)
* Using JetBrains IDEs (CLion, PyCharm) with ROS
* NVIDIA Jetson TX2 with ROS 2


## Status

_Note 1:_ **Bold names** denotes ROS 2 packages.

_Note 2:_ There is _still_ a lot of things in the code
that need to be explained, clarified, decided, ...
Look for **TODO** comments.

_ws/src/:_
* _auxiliary/_
    * **rosmeasure** (Python)
        * currently ported just skeleton
        * TODO: port code
* configs
    * copied 1:1
* _decision_and_control/_
    * **follow_the_gap_v0** (C++)
        * C++ node
    * **follow_the_gap_v0_ride** (Python, launch files)
        * extracted from follow_the_gap_v0 package
* **launchers** (Python, launch files)
    * WIP
    * MVP
        * `ros2 launch launchers stage_sample_ftg.launch.py`
* _messages/_
    * **command_msgs** (IDL)
    * **f1tenth_race** (IDL)
    * **obstacle_msgs** (IDL)
    * **plan_msgs** (IDL)
    * **trajectory** (IDL)
    * **vesc_msgs** (IDL)
* _perception/_
    * _recognition/_
        * **obstacle_substitution** (Python, launch files)
    * _sensors/lidar/_
        * **ust10lx** (Python, launch files with config)
* **storage** (data files)
* _vehicle_platform/_
    * **drive_api** (Python, launch files)
    * **drive_api_msgs** (IDL)
        * extracted from drive_api package,
          so that drive_api could be pure Python package
    * **teensy** (IDL, launch files)
        * TODO: launch file, rosserial_python
    * **vesc** (launch files)
        * TODO: launch file, vesc_driver


## Notes


### Pure Python Package cannot contain messages

ROS 2 _pure_ Python package cannot contain IDL definitions (messages, services)
_(at least for now, it may be supported in the future)_.
It is possible use ament_cmake with Python code but I am not sure
if `colcon build --symlink-install` option works then.
And also it is unnecessary verbose.  


### Launch files are not symlinked

Normally `generate_launch_description` functions should be placed
in their respective launch files (e.g. `launch/start.launch.py`).
**BUT** `--symlink-install` option does not work for launch files:
* see https://github.com/colcon/colcon-core/issues/407
* see https://github.com/ros2/launch/issues/187

We have several possible **workarounds**:
1. _(The currently used one, seems to be the best one.)_ Place launch definitions to package dir and include them
    from respective launch files. This way rebuild is needed only once. 
    The idea comes from https://github.com/colcon/colcon-core/issues/169#issuecomment-531517276
2. Another possible workaround is mentioned here (although it seems rather impractical) https://github.com/ros2/launch/issues/187#issuecomment-468667696.
3. We could create a script to manually symlink them after build (while doing dev). But that would be tiresome and error-prone.


### Python entrypoints `main()` inconsistencies

ROS 2 examples, docs, tutorial and other resources and pretty inconsistent about the style of the `main()` function.

When `main()` is called from autogenerated executable, **no arguments** are passed
(but `sys.argv[0]` may be tweaked).

When `rclpy.init(args=None)` is called, the `args` defaults to
`sys.argv`, see `rclpy/context.py`, **line 59**:
```python
# rclpy/context.py, line 59:
rclpy_implementation.rclpy_init(args if args is not None else sys.argv, capsule)
```

So instead, we might as well set `args` to `sys.argv` directly ourselves
so we can extract what interests us.

So the final `main()` we use for Python entrypoints is:
```python
import sys
import rclpy

def main(args=None):
    if args is None:
        args = sys.argv

    rclpy.init(args=args)

    # ... further code
```


### Others

* **There is no "global parameter server" in ROS 2**
    * see https://discourse.ros.org/t/ros2-global-parameter-server-status/10114
    * see https://github.com/fujitatomoya/ros2_persist_parameter_server
